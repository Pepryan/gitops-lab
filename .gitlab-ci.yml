# workflow:
#   rules:
#   - if: $CI_COMMIT_BRANCH == "main"

variables:
  env_name: $GITLAB_USER_LOGIN-$CI_COMMIT_SHORT_SHA;

stages:
  - validate
  - gen-env
  - tf_plan
  - tf_apply
  - destroying

check-file:
  stage: validate
  script:
    - echo " Validating my terraform codess"
    - terraform validate
  rules:
    - exists:
        - vm.txt
    - when: never
  tags: [kvm]

generate-environment:
  stage: gen-env
  script:
    - random_string=$(echo $RANDOM | md5sum | head -c 5);
    - echo "Generating terraform environment file"
    - echo $GITLAB_USER_LOGIN
    - whoami
    - pwd
    - cp vm.txt /home/gitlab-runner/environment/vm-$env_name.txt
    - cd /home/gitlab-runner/environment
    - ./not-tfgen.sh $env_name vm-$env_name.txt
    - cd $env_name
    - pwd
    - terraform validate
    # - echo $random_string
    # - folder=$(echo $GITLAB_USER_LOGIN-$random_string);
    # - echo ${folder}
    # - ./not-tfgen.sh ${folder} vm.txt
    # - cd ${folder}
    # - pwd
    # - cp ./../provider/terraform-provider-libvirt /home/gitlab-runner/.local/share/terraform/plugins/registry.terraform.io/dmacvicar/libvirt/0.6.2/linux_amd64
    # - terraform init
    # - terraform plan
    # - terraform apply --auto-approve
  rules:
    - exists:
        - vm.txt
    - when: never
  tags: [kvm]
